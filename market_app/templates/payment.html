<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è¨‚å–®çµå¸³ä»˜æ¬¾ - ç·šä¸Šå¸‚å ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* çµ±ä¸€å…¨åŸŸå­—é«”ç‚ºæ›´æ¸…æ™°çš„é»‘é«”çµ„åˆ */
        body { font-family: 'PingFang TC', 'Heiti TC', 'Microsoft JhengHei', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-8">
    <div class="bg-white p-12 rounded-[3rem] shadow-[0_35px_60px_-15px_rgba(0,0,0,0.1)] max-w-2xl w-full border border-gray-100">
        <h2 class="text-3xl font-black text-center mb-10 text-blue-600 tracking-tight">æœ€å¾Œä¸€æ­¥ï¼šç¢ºèªä»˜æ¬¾è³‡è¨Š</h2>
        
        <div id="payment-info" class="space-y-8 mb-12 bg-slate-50 p-8 rounded-3xl">
            <div class="flex justify-between items-center border-b border-gray-200 pb-4">
                <span class="text-gray-500 text-xl font-bold">è¨‚å–®ç·¨è™Ÿ</span>
                <span id="display-order-id" class="font-mono font-black text-2xl text-slate-800">---</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-500 text-xl font-bold">æ‡‰æ”¯ä»˜ç¸½è¨ˆ</span>
                <span id="display-amount" class="text-5xl font-black text-red-600">$0</span>
            </div>
        </div>

        <div class="space-y-5">
            <p class="text-xl font-black text-gray-800 mb-4 pl-2">é¸æ“‡æ‚¨çš„ä»˜æ¬¾æ–¹å¼ï¼š</p>
            
            <button disabled class="w-full py-6 bg-gray-300 text-gray-500 rounded-[2rem] text-2xl font-black cursor-not-allowed shadow-none">
                LINE Pay (æš«æœªé–‹æ”¾)
            </button>

            <button disabled class="w-full py-6 bg-gray-300 text-gray-500 rounded-[2rem] text-2xl font-black cursor-not-allowed shadow-none">
                å…¨æ”¯ä»˜ (æš«æœªé–‹æ”¾)
            </button>

            <button onclick="pay('CASH')" class="w-full py-6 bg-gray-800 text-white rounded-[2rem] text-2xl font-black hover:brightness-95 transition shadow-lg shadow-gray-200 active:scale-95">
                ç¾å ´ç¾é‡‘ä»˜æ¬¾ (åˆ°æ”¤é»æ”¶)
            </button>
        </div>
        
    </div>

    <script>
        // è¨­å®š API åŸºç¤è·¯å¾‘
        const API_BASE = "https://databaseapi-15o1.onrender.com/api";
        // è§£æç¶²å€åƒæ•¸ä¸­çš„ order id (ä¾‹å¦‚: ?id=123)
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');
        // å¾æœ¬åœ°å„²å­˜å–å¾—èº«ä»½é©—è­‰ Token
        const token = localStorage.getItem('token'); 

        /**
         * é é¢åˆå§‹åŒ–ï¼šæª¢æŸ¥æ¬Šé™ä¸¦è®€å–è¨‚å–®è©³ç´°é‡‘é¡
         */
        async function initPayment() {
            // å®‰å…¨æª¢æŸ¥ï¼šè‹¥ç„¡ç™»å…¥å‰‡è·³è½‰
            if (!token) { window.location.href = "/login/"; return; } 
            // åƒæ•¸æª¢æŸ¥ï¼šè‹¥ç¶²å€ç„¡ ID å‰‡å ±éŒ¯
            if (!orderId) { alert("ç„¡æ•ˆçš„è¨‚å–®ç·¨è™Ÿ"); return; }
            
            document.getElementById('display-order-id').innerText = `#${orderId}`;
            
            try {
                // å‘å¾Œç«¯è«‹æ±‚è©²ç­†è¨‚å–®çš„è©³ç´°è³‡æ–™
                const res = await fetch(`${API_BASE}/parent-orders/${orderId}/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                
                if (!res.ok) throw new Error("æ¬Šé™ä¸è¶³æˆ–è¨‚å–®ä¸å­˜åœ¨");
                
                const order = await res.json();
                // æ ¼å¼åŒ–é‡‘é¡ï¼Œç§»é™¤å°æ•¸é»
                const amount = parseFloat(order.final_paid_amount).toFixed(0);
                document.getElementById('display-amount').innerText = `$${amount}`;
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±æ•—:", error);
                alert("ç„¡æ³•è®€å–è¨‚å–®è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥");
            }
        }

        /**
         * è™•ç†ä»˜æ¬¾é‚è¼¯
         * @param {string} method - æ”¯ä»˜æ–¹å¼ä»£ç¢¼ (ä¾‹å¦‚: 'CASH')
         */
        async function pay(method) {
            // äºŒæ¬¡ç¢ºèªï¼Œé¿å…èª¤è§¸
            if(!confirm(`ç¢ºèªä½¿ç”¨ ${method} é€²è¡Œæ”¯ä»˜ï¼Ÿ`)) return;

            try {
                // ä½¿ç”¨ PATCH æ–¹æ³•æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚ºã€Œå·²ä»˜æ¬¾ (paid)ã€ä¸¦è¨˜éŒ„ä»˜æ¬¾æ–¹å¼
                const response = await fetch(`${API_BASE}/parent-orders/${orderId}/`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${token}` 
                    },
                    body: JSON.stringify({ 
                        order_status: 'paid',
                        payment_method: method
                    })
                });

                if (response.ok) {
                    alert("ğŸ‰ ä»˜æ¬¾æˆåŠŸï¼è«‹å‰å¾€å¸‚å ´é ˜å–æ‚¨çš„å•†å“ã€‚");
                    // ä»˜æ¬¾æˆåŠŸå¾Œè·³è½‰è‡³æˆ‘çš„è¨‚å–®é é¢
                    window.location.href = "/my-orders/"; 
                } else {
                    alert("ä»˜æ¬¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹");
                }
            } catch (error) {
                alert("é€£ç·šä¼ºæœå™¨å¤±æ•—");
            }
        }

        // é é¢è¼‰å…¥æ™‚å•Ÿå‹•åˆå§‹åŒ–
        window.onload = initPayment;
    </script>
</body>
</html>