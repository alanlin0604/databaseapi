<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ”¤å•†ç‡Ÿé‹ç®¡ç†ç³»çµ± - æˆ‘çš„å¸‚å ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åº«å­˜é è­¦å‹•ç•«ï¼šç•¶åº«å­˜ä¸è¶³ 5 ä»¶æ™‚ï¼Œè§¸ç™¼ç´…è‰²å‘¼å¸ç‡ˆé‚Šæ¡†æ•ˆæœ */
        @keyframes pulse-red {
            0%, 100% { border-color: #ef4444; box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.4); }
            50% { border-color: #fca5a5; box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .stock-critical { animation: pulse-red 2s infinite; border-width: 2px !important; }
        
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ï¼Œä¿æŒä»‹é¢æ•´æ½” */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ ¹æ“šè¨‚å–®ç‹€æ…‹å®šç¾©ä¸åŒçš„é¡è‰²æ¨™ç±¤ */
        .status-badge-received { background-color: #fef3c7; color: #d97706; } /* å‚™è²¨ä¸­ (é»ƒè‰²) */
        .status-badge-ready { background-color: #dcfce7; color: #16a34a; }    /* å¯å–è²¨ (ç¶ è‰²) */
        .status-badge-completed { background-color: #f1f5f9; color: #64748b; } /* å·²å–è²¨ (ç°è‰²) */
        
        body { font-family: 'PingFang TC', 'Heiti TC', 'Microsoft JhengHei', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans text-base">

    <nav class="bg-slate-900 text-white shadow-2xl sticky top-0 z-50">
        <div class="container mx-auto px-6 py-5 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="bg-blue-600 p-2.5 rounded-xl shadow-inner text-xl">ğŸª</div>
                <h1 class="text-xl font-black tracking-tighter">ç‡Ÿé‹ç®¡ç†ä¸­å¿ƒ</h1>
            </div>
            <div class="flex items-center space-x-6">
                <span id="live-time" class="text-sm font-mono text-slate-400 hidden md:block"></span>
                <a href="/" class="text-base font-bold bg-white/10 hover:bg-white/20 px-6 py-2.5 rounded-full transition-all">è¿”å›å‰å°</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6 lg:p-10">
        <div class="flex space-x-4 mb-10 bg-slate-200/50 p-2 rounded-2xl w-fit backdrop-blur-md">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-7 py-3 rounded-xl font-bold transition-all text-base text-slate-500 hover:text-slate-800">æ•¸æ“šæ¦‚è¦½</button>
            <button onclick="switchTab('products')" id="tab-products" class="px-7 py-3 rounded-xl font-bold transition-all text-base text-slate-500 hover:text-slate-800">åº«å­˜å•†å“</button>
            <button onclick="switchTab('orders')" id="tab-orders" class="px-7 py-3 rounded-xl font-bold transition-all text-base text-slate-500 hover:text-slate-800">è¨‚å–®ç®¡ç†</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="px-7 py-3 rounded-xl font-bold transition-all text-base text-slate-500 hover:text-slate-800">åº—é‹ªè¨­å®š</button>
        </div>

        <div id="dashboard-section" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-sm font-black uppercase tracking-widest">ä»Šæ—¥æˆäº¤</p>
                    <h2 id="stat-today-revenue" class="text-5xl font-black text-slate-900 mt-3">$0</h2>
                    <p class="text-xs text-green-500 font-bold mt-3">â— å³æ™‚æ›´æ–°ä¸­</p>
                </div>
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-sm font-black uppercase tracking-widest">ç´¯è¨ˆç‡Ÿæ”¶</p>
                    <h2 id="stat-total-revenue" class="text-5xl font-black text-slate-900 mt-3">$0</h2>
                </div>
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-sm font-black uppercase tracking-widest">å¾…è™•ç†è¨‚å–®</p>
                    <h2 id="stat-pending-orders" class="text-5xl font-black text-blue-600 mt-3">0</h2>
                </div>
            </div>
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 p-12">
                <h3 class="text-2xl font-black text-slate-900 mb-10">ç†±éŠ·æ’è¡Œæ¦œ</h3>
                <div id="top-products-list" class="space-y-6"></div>
            </div>
        </div>

        <div id="products-section" class="hidden space-y-8">
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 p-10 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h2 class="text-3xl font-black text-slate-900">åº«å­˜å•†å“æ¸…å–®</h2>
                    <p class="text-slate-500 text-base mt-2">ç®¡ç†æ¶ä¸Šå•†å“èˆ‡å³æ™‚åº«å­˜æ•¸é‡</p>
                </div>
                <button onclick="openModal()" class="bg-blue-600 text-white px-12 py-4.5 rounded-2xl font-black shadow-xl shadow-blue-100 hover:scale-105 active:scale-95 transition-all text-lg">
                    + æ–°å¢å•†å“
                </button>
            </div>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <div id="orders-section" class="hidden space-y-8">
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 p-10 mb-6">
                <h2 class="text-3xl font-black text-slate-900">å³æ™‚è¨‚å–®è™•ç†å€</h2>
                <p class="text-slate-500 text-base mt-2">å±•é–‹æ˜ç´°å³å¯æŸ¥çœ‹é¡§å®¢éœ€æ±‚ï¼Œä¸¦æ‰‹å‹•æ›´æ”¹è¨‚å–®ç‹€æ…‹</p>
            </div>
            <div id="stall-order-list" class="grid grid-cols-1 gap-8"></div>
        </div>

        <div id="settings-section" class="hidden">
            <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 p-12 max-w-2xl mx-auto">
                <h2 class="text-3xl font-black text-slate-900 mb-3">åº—é‹ªè³‡è¨Š</h2>
                <p class="text-slate-500 text-base mb-10">æ›´æ”¹ç‡Ÿæ¥­æ™‚é–“ã€åç¨±æˆ–åº—é‹ªç°¡ä»‹ã€‚</p>
                <form id="stall-settings-form" class="space-y-8">
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <label class="block text-xs font-black text-slate-400 uppercase mb-3">åº—å</label>
                            <input type="text" id="s-name" required class="w-full px-6 py-4 rounded-2xl border border-slate-200 bg-slate-50 outline-none text-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-400 uppercase mb-3">é›»è©±</label>
                            <input type="text" id="s-phone" required class="w-full px-6 py-4 rounded-2xl border border-slate-200 bg-slate-50 outline-none text-lg">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <label class="block text-xs font-black text-slate-400 uppercase mb-3">é–‹å¸‚æ™‚é–“</label>
                            <input type="time" id="s-open" required class="w-full px-6 py-4 rounded-2xl border border-slate-200 text-lg">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-400 uppercase mb-3">æ”¶æ”¤æ™‚é–“</label>
                            <input type="time" id="s-close" required class="w-full px-6 py-4 rounded-2xl border border-slate-200 text-lg">
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 p-5 bg-blue-50 rounded-2xl border border-blue-100">
                        <input type="checkbox" id="s-active" class="w-6 h-6 rounded-lg text-blue-600 focus:ring-blue-500">
                        <label for="s-active" class="text-base font-black text-blue-800">ç›®å‰åº—é‹ªç‡Ÿé‹ä¸­</label>
                    </div>
                    <button type="submit" class="w-full bg-slate-900 text-white py-6 rounded-2xl font-black active:scale-95 transition-all text-xl">
                        å„²å­˜æ‰€æœ‰è¨­å®š
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="product-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white rounded-[3rem] max-w-xl w-full shadow-2xl p-12 overflow-y-auto max-h-[90vh]">
            <h2 id="modal-title" class="text-3xl font-black text-slate-900 mb-10">ç·¨è¼¯å•†å“</h2>
            <form id="product-form" class="space-y-6">
                <input type="hidden" id="p-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-400 mb-3 uppercase">å“å</label>
                        <input type="text" id="p-name" required class="w-full px-6 py-4 rounded-2xl border text-lg focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-3 uppercase">å”®åƒ¹ ($)</label>
                        <input type="number" id="p-price" required class="w-full px-6 py-4 rounded-2xl border text-lg focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-3 uppercase">å–®ä½ (å¦‚ï¼šä»½/å…¬æ–¤)</label>
                        <input type="text" id="p-unit" required class="w-full px-6 py-4 rounded-2xl border text-lg focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-3 uppercase">ç›®å‰åº«å­˜</label>
                        <input type="number" id="p-stock" required class="w-full px-6 py-4 rounded-2xl border text-lg focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-3 uppercase">åˆ†é¡</label>
                        <select id="p-category" required class="w-full px-6 py-4 rounded-2xl border text-lg appearance-none bg-white focus:border-blue-500 outline-none"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-3 uppercase">å•†å“ç°¡ä»‹</label>
                    <textarea id="p-desc" rows="2" class="w-full px-6 py-4 rounded-2xl border text-lg focus:border-blue-500 outline-none" placeholder="å‘é¡§å®¢ä»‹ç´¹é€™ä»½é£Ÿæ..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-3 uppercase">å•†å“ç…§ç‰‡ç¶²å€ (URL)</label>
                    <input type="url" id="p-image-url" class="w-full px-6 py-4 rounded-2xl border text-lg focus:border-blue-500 outline-none" placeholder="https://example.com/image.jpg">
                    <p class="text-slate-400 text-xs mt-2">è«‹è²¼ä¸Šç¶²è·¯åœ–ç‰‡é€£çµï¼Œå»ºè­°ä½¿ç”¨ Imgur æˆ–ç¶²è·¯å…¬é–‹åœ–ç‰‡ã€‚</p>
                </div>
                <div class="flex space-x-4 pt-8">
                    <button type="button" onclick="closeModal()" class="flex-1 py-5 bg-slate-100 rounded-2xl font-bold text-lg hover:bg-slate-200">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 py-5 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all">å„²å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // è¨­å®š API åŸºç¤è·¯å¾‘èˆ‡èº«ä»½é©—è­‰ Token
        const API_BASE = "https://databaseapi-15o1.onrender.com/api";
        const token = localStorage.getItem('token');
        let currentStallId = null;
        let allProducts = [];

        /**
         * é é¢è¼‰å…¥åˆå§‹åŒ–
         */
        window.onload = async () => {
            // æ¯ç§’æ›´æ–°å³æ™‚æ™‚é˜
            setInterval(() => {
                const el = document.getElementById('live-time');
                if (el) el.innerText = new Date().toLocaleTimeString();
            }, 1000);
            
            await loadStallSettings(); // é¦–å…ˆç²å–æ”¤å•† ID
            switchTab('dashboard');   // é è¨­é€²å…¥æ•¸æ“šçœ‹æ¿
        };

        /**
         * åˆ†é åˆ‡æ›é‚è¼¯
         * @param {string} tab - ç›®æ¨™åˆ†é  ID
         */
        function switchTab(tab) {
            const tabs = ['dashboard', 'products', 'orders', 'settings'];
            tabs.forEach(t => {
                const section = document.getElementById(`${t}-section`);
                const btn = document.getElementById(`tab-${t}`);
                if (section) section.classList.add('hidden');
                if (btn) btn.className = "px-7 py-3 rounded-xl font-bold transition-all text-base text-slate-500 hover:text-slate-800";
            });

            // é¡¯ç¤ºç•¶å‰é¸ä¸­çš„å€åŸŸ
            const activeSection = document.getElementById(`${tab}-section`);
            const activeBtn = document.getElementById(`tab-${tab}`);
            if (activeSection) activeSection.classList.remove('hidden');
            if (activeBtn) activeBtn.className = "px-7 py-3 rounded-xl font-bold transition-all text-base bg-white shadow-lg text-blue-600";
            
            // æ ¹æ“šåˆ†é è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tab === 'dashboard') loadDashboardData();
            if (tab === 'products') loadMyProducts();
            if (tab === 'orders') loadStallOrders();
            if (tab === 'settings') loadStallSettings();
        }

        /**
         * è¼‰å…¥æ•¸æ“šçœ‹æ¿è³‡è¨Š (ç‡Ÿæ”¶ã€ç†±éŠ·æ’è¡Œ)
         */
        async function loadDashboardData() {
            if (!currentStallId) return;
            try {
                const res = await fetch(`${API_BASE}/stalls/${currentStallId}/dashboard_stats/`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                const data = await res.json();
                
                // æ›´æ–°æ•¸å­—çµ±è¨ˆ
                document.getElementById('stat-today-revenue').innerText = `$${Math.round(data.today_revenue || 0)}`;
                document.getElementById('stat-total-revenue').innerText = `$${Math.round(data.total_revenue || 0)}`;
                
                // æ¸²æŸ“ç†±éŠ·æ’è¡Œé€²åº¦æ¢
                const topList = document.getElementById('top-products-list');
                if (data.top_products && data.top_products.length > 0) {
                    const maxQty = Math.max(...data.top_products.map(p => p.total_qty), 1);
                    topList.innerHTML = data.top_products.map((p, index) => {
                        const progress = (p.total_qty / maxQty) * 100;
                        return `
                            <div class="space-y-3">
                                <div class="flex justify-between text-base font-black">
                                    <span>${index + 1}. ${p.product__name}</span>
                                    <span class="text-blue-600">å”®å‡º ${p.total_qty}</span>
                                </div>
                                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500" style="width: ${progress}%"></div>
                                </div>
                            </div>`;
                    }).join('');
                } else {
                    topList.innerHTML = '<p class="text-slate-400 py-12 text-center text-base">ç›®å‰å°šç„¡æˆäº¤æ•¸æ“š</p>';
                }

                // ç²å–å¾…è™•ç†è¨‚å–®æ•¸é‡
                const orderRes = await fetch(`${API_BASE}/stall-manager/orders/`, { headers: { 'Authorization': `Token ${token}` } });
                const orders = await orderRes.json();
                document.getElementById('stat-pending-orders').innerText = orders.filter(o => o.order_status === 'received').length;

            } catch (e) { console.error("Dashboard è³‡æ–™ç²å–å¤±æ•—"); }
        }

        /**
         * è¼‰å…¥æ”¤å•†æ“æœ‰çš„å•†å“èˆ‡åº«å­˜
         */
        async function loadMyProducts() {
            try {
                const res = await fetch(`${API_BASE}/stall-manager/products/`, { headers: { 'Authorization': `Token ${token}` } });
                allProducts = await res.json();
                const container = document.getElementById('product-list');
                
                container.innerHTML = allProducts.map(p => {
                    const isCritical = p.stock_quantity < 5; // å®šç¾©åº«å­˜è­¦å‘Šé–€æª»
                    return `
                        <div class="bg-white border rounded-[2.5rem] p-8 shadow-sm ${isCritical ? 'stock-critical' : 'border-slate-100'} hover:shadow-xl transition-all">
                            <div class="flex items-center space-x-5">
                                <img src="${p.image_display || p.image_url || 'https://via.placeholder.com/80?text=ç„¡åœ–ç‰‡'}" class="w-20 h-20 object-cover rounded-2xl shadow-sm" onerror="this.src='https://via.placeholder.com/80?text=éŒ¯èª¤'">
                                <div class="flex-1">
                                    <h3 class="font-black text-lg text-slate-900">${p.name}</h3>
                                    <p class="text-sm ${isCritical ? 'text-red-500 font-black' : 'text-slate-500'}">åº«å­˜ï¼š${p.stock_quantity} ${p.unit}</p>
                                    <p class="text-blue-600 font-black mt-2 text-lg">$${Math.round(p.price)}</p>
                                </div>
                                <button onclick="openModal(${p.id})" class="p-3 bg-slate-50 rounded-xl hover:bg-slate-100 text-xl">âš™ï¸</button>
                            </div>
                        </div>`;
                }).join('');
            } catch (e) { console.error("ç”¢å“æ¸…å–®è¼‰å…¥å¤±æ•—"); }
        }

        /**
         * è¼‰å…¥æ”¤å•†å°ˆå±¬çš„å­è¨‚å–®åˆ—è¡¨
         */
        async function loadStallOrders() {
            try {
                const res = await fetch(`${API_BASE}/stall-manager/orders/`, { headers: { 'Authorization': `Token ${token}` } });
                const orders = await res.json();
                const container = document.getElementById('stall-order-list');
                
                container.innerHTML = orders.map(order => {
                    // ç‹€æ…‹ UI åˆ†æ”¯
                    let statusClass = "status-badge-received";
                    let statusText = "å‚™è²¨ä¸­";
                    if(order.order_status === 'ready_for_pickup') { statusClass = "status-badge-ready"; statusText = "å¯å–è²¨"; }
                    if(order.order_status === 'completed') { statusClass = "status-badge-completed"; statusText = "å·²å–è²¨"; }

                    return `
                        <div class="bg-white border border-slate-100 rounded-[2.5rem] p-10 shadow-sm">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                                <div class="space-y-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs font-black text-slate-300 tracking-wider">å­è¨‚å–® #SUB-${order.id}</span>
                                        <span class="text-xs font-bold text-blue-400">/ ä¸»å–® #${order.parent_order_id || order.parent_order}</span>
                                    </div>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <h3 class="font-black text-3xl text-slate-900">${statusText}</h3>
                                        <span class="px-4 py-1.5 rounded-full text-xs font-black uppercase ${statusClass}">${order.order_status}</span>
                                    </div>
                                    <div class="flex items-center text-slate-500 mt-2 bg-slate-50 w-fit px-4 py-1 rounded-full border border-slate-100">
                                        <span class="text-sm font-bold mr-2">ğŸ‘¤ é¡§å®¢ï¼š</span>
                                        <span class="text-base font-black text-slate-800">${order.customer_name || 'ç³»çµ±æŸ¥è©¢ä¸­...'}</span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-4">
                                    <button onclick="toggleOrderDetail(${order.id})" class="bg-slate-100 px-8 py-3.5 rounded-2xl font-bold hover:bg-slate-200 transition-colors text-base">æŸ¥çœ‹æ˜ç´°</button>
                                    <div class="relative">
                                        <select onchange="updateOrderStatus(${order.id}, this.value)" class="appearance-none bg-blue-600 text-white pl-8 pr-12 py-3.5 rounded-2xl font-black cursor-pointer hover:bg-blue-700 transition-colors outline-none shadow-lg shadow-blue-100 text-base">
                                            <option value="received" ${order.order_status === 'received' ? 'selected' : ''}>å‚™è²¨ä¸­</option>
                                            <option value="ready_for_pickup" ${order.order_status === 'ready_for_pickup' ? 'selected' : ''}>å¯å–è²¨</option>
                                            <option value="completed" ${order.order_status === 'completed' ? 'selected' : ''}>å·²å–è²¨</option>
                                        </select>
                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-5 text-white">
                                            <svg class="fill-current h-5 w-5" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="order-detail-${order.id}" class="hidden mt-10 pt-10 border-t">
                                <div class="bg-slate-50 p-8 rounded-[2rem] text-lg" id="items-list-${order.id}">è¼‰å…¥ä¸­...</div>
                            </div>
                        </div>`;
                }).join('');
            } catch (e) { console.error("è¨‚å–®è¼‰å…¥å¤±æ•—"); }
        }

        /**
         * å±•é–‹/æ”¶åˆè¨‚å–®è©³ç´°å•†å“æ¸…å–®
         */
        async function toggleOrderDetail(orderId) {
            const panel = document.getElementById(`order-detail-${orderId}`);
            if (!panel.classList.contains('hidden')) {
                panel.classList.add('hidden');
                return;
            }
            panel.classList.remove('hidden');
            try {
                // å‘å¾Œç«¯è«‹æ±‚å­è¨‚å–®å…§çš„å•†å“é …ç›®æ˜ç´°
                const res = await fetch(`${API_BASE}/order-items/?sub_order_id=${orderId}`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                const items = await res.json();
                const list = document.getElementById(`items-list-${orderId}`);
                list.innerHTML = items.map(i => `
                    <div class="flex justify-between py-3 border-b border-white last:border-0">
                        <span class="font-bold text-slate-700">${i.product_name}</span>
                        <span class="text-base font-mono bg-white px-3 py-1 rounded-lg shadow-sm font-black">x ${i.quantity}</span>
                    </div>`).join('') || "ç„¡å•†å“æ˜ç´°";
            } catch (e) { document.getElementById(`items-list-${orderId}`).innerText = "è³‡æ–™è¼‰å…¥å¤±æ•—"; }
        }

        /**
         * æ›´æ–°å­è¨‚å–®ç‹€æ…‹ï¼ˆä¾‹å¦‚å¾ å‚™è²¨ä¸­ -> å¯å–è²¨ï¼‰
         */
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const res = await fetch(`${API_BASE}/stall-manager/orders/${orderId}/update_status/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                    body: JSON.stringify({ status: newStatus })
                });
                if (res.ok) {
                    loadStallOrders();    // é‡æ–°è¼‰å…¥åˆ—è¡¨åˆ·æ–° UI
                    loadDashboardData();  // åˆ·æ–°çµ±è¨ˆæ•¸å­—
                }
            } catch (e) { alert("ç„¡æ³•é€£ç·šä¼ºæœå™¨é€²è¡Œæ›´æ–°"); }
        }

        /**
         * è®€å–åº—é‹ªåŸºæœ¬è³‡æ–™
         */
        async function loadStallSettings() {
            try {
                // ?admin=true åƒæ•¸é€šå¸¸ç”±å¾Œç«¯ç”¨ä¾†ç¯©é¸å‡ºè©²ç®¡ç†å“¡æ‰€å±¬çš„æ”¤å•†
                const res = await fetch(`${API_BASE}/stalls/?admin=true`, { headers: { 'Authorization': `Token ${token}` } });
                const stalls = await res.json();
                if (stalls.length > 0) {
                    const myStall = stalls[0];
                    currentStallId = myStall.id;
                    document.getElementById('s-name').value = myStall.name || "";
                    document.getElementById('s-phone').value = myStall.contact_phone || "";
                    // æ ¼å¼åŒ–æ™‚é–“ï¼š08:00:00 -> 08:00
                    if (myStall.open_time) document.getElementById('s-open').value = myStall.open_time.slice(0,5);
                    if (myStall.close_time) document.getElementById('s-close').value = myStall.close_time.slice(0,5);
                    document.getElementById('s-active').checked = myStall.is_active;
                }
            } catch (e) { console.error("åº—é‹ªè¨­å®šè¼‰å…¥å¤±æ•—"); }
        }

        /**
         * è¼‰å…¥å…¨åŸŸåˆ†é¡æ¸…å–® (ç”¨æ–¼æ–°å¢å•†å“æ™‚çš„ä¸‹æ‹‰é¸å–®)
         */
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/categories/`);
                const data = await res.json();
                document.getElementById('p-category').innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } catch (e) { console.error("å•†å“åˆ†é¡è¼‰å…¥å¤±æ•—"); }
        }

        function closeModal() { document.getElementById('product-modal').classList.add('hidden'); }

        /**
         * é–‹å•Ÿæ–°å¢/ç·¨è¼¯å•†å“çš„å½ˆçª—
         * @param {number|null} productId - è‹¥å‚³å…¥ ID å‰‡ç‚ºç·¨è¼¯æ¨¡å¼ï¼Œå¦å‰‡ç‚ºæ–°å¢æ¨¡å¼
         */
        async function openModal(productId = null) {
            await loadCategories();
            document.getElementById('p-id').value = productId || "";
            document.getElementById('modal-title').innerText = productId ? "ä¿®æ”¹å•†å“è©³æƒ…" : "æ–°å¢ç¾è²¨å“é …";
            
            if (productId) {
                const p = allProducts.find(item => item.id === productId);
                if (p) {
                    document.getElementById('p-name').value = p.name;
                    document.getElementById('p-price').value = Math.round(p.price);
                    document.getElementById('p-unit').value = p.unit;
                    document.getElementById('p-stock').value = p.stock_quantity;
                    document.getElementById('p-desc').value = p.description || "";
                    document.getElementById('p-category').value = p.category;
                    document.getElementById('p-image-url').value = p.image_url || "";
                }
            } else {
                document.getElementById('product-form').reset();
                document.getElementById('p-stock').value = 0;
            }
            document.getElementById('product-modal').classList.remove('hidden');
        }

        /**
         * å•†å“è¡¨å–®æäº¤è™•ç† (POST/PATCH)
         */
        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const pId = document.getElementById('p-id').value;
            const url = pId ? `${API_BASE}/stall-manager/products/${pId}/` : `${API_BASE}/stall-manager/products/`;
            const method = pId ? 'PATCH' : 'POST';
            
            const data = {
                name: document.getElementById('p-name').value,
                price: document.getElementById('p-price').value,
                unit: document.getElementById('p-unit').value,
                stock_quantity: document.getElementById('p-stock').value,
                description: document.getElementById('p-desc').value,
                category: document.getElementById('p-category').value,
                image_url: document.getElementById('p-image-url').value,
                status: 'on_shelf'
            };

            try {
                const res = await fetch(url, { 
                    method: method, 
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${token}` 
                    }, 
                    body: JSON.stringify(data)
                });
                if (res.ok) { 
                    closeModal(); 
                    loadMyProducts(); // é‡æ–°æ•´ç†æ¸…å–®
                } else {
                    const err = await res.json();
                    alert("å„²å­˜å¤±æ•—ï¼š" + JSON.stringify(err));
                }
            } catch (e) { alert("ç³»çµ±ç™¼ç”Ÿç•°å¸¸ï¼Œè«‹æª¢æŸ¥é€£ç·š"); }
        };

        /**
         * å„²å­˜åº—é‹ªè¨­å®šè®Šæ›´
         */
        document.getElementById('stall-settings-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('s-name').value,
                contact_phone: document.getElementById('s-phone').value,
                open_time: document.getElementById('s-open').value,
                close_time: document.getElementById('s-close').value,
                is_active: document.getElementById('s-active').checked
            };
            const res = await fetch(`${API_BASE}/stalls/${currentStallId}/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                body: JSON.stringify(data)
            });
            if (res.ok) alert("âœ… åº—é‹ªè¨­å®šå·²æˆåŠŸå„²å­˜");
        };
    </script>
</body>
</html>