<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ­·å²è¨‚å–® - ç·šä¸Šå¸‚å ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* çµ±ä¸€å­—é«”è¨­å®šï¼Œç¢ºä¿åœ¨ä¸åŒè£ç½®ä¸Šéƒ½æœ‰è‰¯å¥½çš„é–±è®€é«”é©— */
        body { font-family: 'PingFang TC', 'Heiti TC', 'Microsoft JhengHei', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-lg"> 
    <nav class="bg-gray-800 p-8 text-white shadow-lg"> 
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-4xl font-black tracking-tight">ğŸ“œ æˆ‘çš„è³¼è²·ç´€éŒ„</h1> 
            <a href="/" class="text-xl font-bold hover:underline bg-white/10 px-6 py-2 rounded-xl transition">è¿”å›é¦–é </a> 
        </div>
    </nav>

    <div class="container mx-auto p-8">
        <div id="order-container" class="space-y-8"> 
            <p class="text-gray-500 text-center py-20 text-2xl font-bold">æ­£åœ¨è®€å–è¨‚å–®...</p>
        </div>
    </div>

    <script>
        // è¨­å®š API åŸºç¤é€£ç·šè·¯å¾‘èˆ‡èº«ä»½é©—è­‰ Token
        const API_BASE = "https://databaseapi-15o1.onrender.com/api";
        const token = localStorage.getItem('token');

        // æ¬Šé™æª¢æŸ¥ï¼šæœªç™»å…¥è€…ç›´æ¥å¼•å°è‡³ç™»å…¥é é¢
        if (!token) {
            alert("è«‹å…ˆç™»å…¥æœƒå“¡ä»¥æŸ¥çœ‹è¨‚å–®ç´€éŒ„");
            window.location.href = "/login/";
        }

        /**
         * ç•°æ­¥è¼‰å…¥ç‰¹å®šè¨‚å–®çš„å•†å“æ˜ç´°
         * @param {number} orderId - çˆ¶è¨‚å–® ID
         * @param {string} elementId - è¦æ¸²æŸ“æ˜ç´°çš„å®¹å™¨ ID
         */
        async function loadOrderItems(orderId, elementId) {
            try {
                // å‘å¾Œç«¯è«‹æ±‚è©²ç­†è¨‚å–®çš„æ‰€æœ‰å•†å“é …ç›®
                const res = await fetch(`${API_BASE}/order-items/?parent_id=${orderId}`, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                const items = await res.json();
                const listEl = document.getElementById(elementId);
                if (!listEl) return;

                // æ¸²æŸ“å•†å“æ¸…å–® HTML
                listEl.innerHTML = `
                    <div class="bg-gray-50 p-6 rounded-2xl mt-4 border border-gray-200">
                        <p class="text-base font-black text-gray-400 mb-4 uppercase tracking-widest">å•†å“æ˜ç´°</p>
                        ${items.map(item => `
                            <div class="flex justify-between text-xl py-3 border-b border-gray-200 last:border-0">
                                <span class="text-gray-800 font-bold">
                                    ${item.product_name || 'æœªçŸ¥å•†å“'} 
                                    <span class="text-gray-400 ml-2">x ${item.quantity}</span>
                                </span>
                                <span class="font-black text-gray-900">$${Math.round(item.unit_price_snapshot * item.quantity)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (err) { console.error("è¼‰å…¥æ˜ç´°å¤±æ•—:", err); }
        }

        /**
         * æŠ“å–æ‰€æœ‰çˆ¶è¨‚å–®ç´€éŒ„ä¸¦æ¸²æŸ“
         */
        async function fetchOrders() {
            try {
                const response = await fetch(`${API_BASE}/parent-orders/`, {
                    headers: { 'Authorization': `Token ${token}` }
                }); 
                const orders = await response.json();
                const container = document.getElementById('order-container');
                container.innerHTML = '';

                // è‹¥ç„¡è¨‚å–®æ™‚çš„è™•ç†
                if (orders.length === 0) {
                    container.innerHTML = '<p class="text-center py-20 text-gray-500 text-2xl font-bold">å°šç„¡ä»»ä½•è¨‚å–®ç´€éŒ„</p>';
                    return;
                }

                // æ’åºï¼šå°‡æœ€æ–°çš„è¨‚å–®æ”¾åœ¨æœ€ä¸Šæ–¹
                orders.sort((a, b) => b.id - a.id).forEach(order => {
                    // æ ¹æ“šè¨‚å–®ç‹€æ…‹è¨­å®š UI æ¨£å¼
                    const isPaid = order.order_status === 'paid';
                    const statusText = isPaid ? 'âœ… å·²ä»˜æ¬¾å®Œæˆ' : 'â³ è¨‚å–®å¾…è™•ç†';
                    const statusClass = isPaid ? 'text-green-600' : 'text-amber-600';
                    const borderClass = isPaid ? 'border-green-500' : 'border-amber-500';

                    // æ§‹å»ºè¨‚å–®å¡ç‰‡ HTML
                    container.innerHTML += `
                        <div class="bg-white rounded-[2.5rem] shadow-xl p-10 mb-10 border-l-[16px] ${borderClass} transition-all hover:shadow-2xl">
                            <div class="flex justify-between items-center mb-6">
                                <span class="text-gray-400 text-lg font-mono font-bold">è¨‚å–®ç·¨è™Ÿ #${order.id} | ${new Date(order.order_date).toLocaleString()}</span>
                                <span class="text-2xl font-black ${statusClass}">${statusText}</span>
                            </div>

                            <div id="items-container-${order.id}" class="mb-6"></div>

                            <div class="flex justify-between items-end pt-8 border-t-2 border-gray-100">
                                <div class="text-gray-500 text-lg font-bold flex flex-col space-y-2">
                                    <span class="bg-gray-100 px-4 py-2 rounded-lg w-fit">ä»˜æ¬¾æ–¹å¼ï¼š${order.payment_method || 'æœªè¨­å®š'}</span>
                                    <span class="text-green-600 bg-green-50 px-4 py-2 rounded-lg w-fit flex items-center">
                                        ğŸ’° æœ¬æ¬¡ç²å¾—ï¼š${order.earned_points} é»
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-gray-400 text-base font-black block mb-1">å¯¦ä»˜ç¸½é¡</span>
                                    <span class="text-6xl font-black text-red-600">$${Math.round(parseFloat(order.final_paid_amount))}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    // å¡ç‰‡æ¶æ§‹ç”¢ç”Ÿå¾Œï¼Œç«‹å³è§¸ç™¼è¼‰å…¥è©²è¨‚å–®çš„è©³ç´°å•†å“
                    loadOrderItems(order.id, `items-container-${order.id}`);
                });
            } catch (err) { 
                console.error("æŠ“å–è¨‚å–®å¤±æ•—:", err);
                document.getElementById('order-container').innerHTML = '<p class="text-center py-20 text-red-500">ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
            }
        }

        // ç•¶é é¢è¼‰å…¥å®Œæˆæ™‚åŸ·è¡Œ
        window.onload = fetchOrders;
    </script>
</body>
</html>