<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„è³¼ç‰©è»Š - å‚³çµ±å¸‚å ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* çµ±ä¸€å­—é«”åŠ ç²—èˆ‡ç´°ç¯€ç¾åŒ– */
        body { font-family: 'PingFang TC', 'Heiti TC', 'Microsoft JhengHei', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-lg"> 
    <nav class="bg-blue-600 p-6 text-white shadow-lg"> 
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-black tracking-tight">ğŸ›’ æˆ‘çš„è³¼ç‰©è»Š</h1> 
            <a href="/" class="text-xl font-bold hover:underline bg-white/10 px-6 py-2 rounded-xl transition">â† è¿”å›é¦–é </a>
        </div>
    </nav>

    <div class="container mx-auto p-8">
        <div class="bg-white rounded-[2.5rem] shadow-2xl p-10"> 
            <div id="cart-container" class="overflow-x-auto">
                <p class="text-center py-20 text-2xl text-gray-400 font-bold">æ­£åœ¨è®€å–è³¼ç‰©æ¸…å–®...</p>
            </div>

            <div class="mt-12 border-t pt-10 flex flex-col md:flex-row justify-between items-center gap-8">
                <div class="bg-blue-50 p-8 rounded-[2rem] border border-blue-100 w-full md:w-auto">
                    <p class="text-lg text-blue-600 font-black mb-3">å¯ç”¨é»æ•¸ï¼š<span id="user-points" class="text-2xl ml-2">0</span></p>
                    <div class="flex items-center space-x-3">
                        <input type="number" id="input-points" placeholder="è¼¸å…¥æŠ˜æŠµé»æ•¸" 
                               class="border-2 border-blue-200 rounded-xl px-5 py-3 w-48 text-xl outline-none focus:border-blue-500 transition-all">
                        <span class="text-lg font-bold text-gray-500">é»</span>
                    </div>
                </div>
                
                <div class="text-right w-full md:w-auto">
                    <p class="text-gray-400 text-xl font-black mb-2">æ‡‰ä»˜ç¸½è¨ˆ</p>
                    <p id="total-price" class="text-6xl font-black text-red-600 mb-6">$0</p>
                    <button onclick="checkout()" class="w-full md:w-auto bg-green-500 text-white px-16 py-5 rounded-2xl font-black text-3xl hover:bg-green-600 transition shadow-xl shadow-green-100 active:scale-95">
                        ç«‹å³çµå¸³ä»˜æ¬¾
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š API åŸºç¤è·¯å¾‘èˆ‡å¾æœ¬åœ°å„²å­˜è®€å–èº«ä»½é©—è­‰ Token
        const API_BASE = "https://databaseapi-15o1.onrender.com/api";
        const token = localStorage.getItem('token');

        /**
         * æŠ“å–ä¸¦æ¸²æŸ“è³¼ç‰©è»Šè³‡æ–™
         */
        async function fetchCart() {
            try {
                // å¹³è¡Œç™¼é€ä¸‰å€‹è«‹æ±‚ï¼šè³¼ç‰©è»Šå…§å®¹ã€å•†å“æ¸…å–®ã€ä½¿ç”¨è€…è³‡æ–™
                const [cartRes, prodRes, userRes] = await Promise.all([
                    fetch(`${API_BASE}/cart/`, { headers: { 'Authorization': `Token ${token}` } }),
                    fetch(`${API_BASE}/products/`),
                    fetch(`${API_BASE}/member/me/`, { headers: { 'Authorization': `Token ${token}` } })
                ]);

                const cartData = await cartRes.json();
                const products = await prodRes.json();
                const userData = await userRes.json();

                // æ›´æ–°ä»‹é¢ä¸Šçš„å¯ç”¨é»æ•¸
                document.getElementById('user-points').innerText = userData.current_points;

                const container = document.getElementById('cart-container');
                // è‹¥è³¼ç‰©è»Šç‚ºç©ºå‰‡é¡¯ç¤ºæç¤ºè¨Šæ¯
                if (!cartData.length) {
                    container.innerHTML = '<p class="text-center py-20 text-3xl text-gray-300 font-black">æ‚¨çš„è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„</p>';
                    return;
                }

                let total = 0;
                // åˆå§‹åŒ–è¡¨æ ¼æ¨™é¡Œ
                let html = `<table class="w-full text-left min-w-[700px]">
                    <tr class="text-gray-400 text-lg border-b-2"><th class="py-4 px-2">å•†å“é …ç›®</th><th class="text-center">å–®åƒ¹</th><th class="text-center">æ•¸é‡</th><th class="text-center">å°è¨ˆ</th><th></th></tr>`;

                // éæ­·è³¼ç‰©è»Šé …ç›®ä¸¦åŒ¹é…ç”¢å“è©³ç´°è³‡è¨Š
                cartData.forEach(item => {
                    const product = products.find(p => p.id == item.product);
                    if (product) {
                        const subtotal = product.price * item.quantity;
                        total += subtotal;
                        html += `
                            <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                                <td class="py-8 px-2 flex items-center space-x-6">
                                    <img src="${product.image_display || product.image_url}" class="w-24 h-24 object-cover rounded-2xl shadow-md">
                                    <span class="font-black text-2xl text-gray-800">${product.name}</span>
                                </td>
                                <td class="text-center text-xl font-bold text-gray-600">$${Math.round(product.price)}</td>
                                <td class="text-center">
                                    <div class="flex items-center justify-center space-x-4">
                                        <button onclick="updateQty(${item.id}, ${item.quantity-1})" class="w-10 h-10 border-2 border-gray-300 rounded-xl font-black text-xl hover:bg-gray-100">-</button>
                                        <span class="font-black text-2xl w-8 text-center">${item.quantity}</span>
                                        <button onclick="updateQty(${item.id}, ${item.quantity+1})" class="w-10 h-10 border-2 border-gray-300 rounded-xl font-black text-xl hover:bg-gray-100">+</button>
                                    </div>
                                </td>
                                <td class="text-center font-black text-3xl text-red-500">$${Math.round(subtotal)}</td>
                                <td class="text-right"><button onclick="deleteItem(${item.id})" class="text-gray-300 hover:text-red-500 text-lg font-bold">ç§»é™¤</button></td>
                            </tr>`;
                    }
                });

                // æ¸²æŸ“å®Œæ•´è¡¨æ ¼ä¸¦æ›´æ–°ç¸½åƒ¹
                container.innerHTML = html + `</table>`;
                document.getElementById('total-price').innerText = `$${Math.round(total)}`;
            } catch (e) { console.error("è®€å–è³¼ç‰©è»Šå¤±æ•—:", e); }
        }

        /**
         * æ›´æ–°å•†å“æ•¸é‡
         * @param {number} id - è³¼ç‰©è»Šé …ç›®çš„ ID
         * @param {number} qty - ç›®æ¨™æ•¸é‡
         */
        async function updateQty(id, qty) {
            // å¦‚æœæ•¸é‡å°æ–¼ 1ï¼ŒåŸ·è¡Œåˆªé™¤é‚è¼¯
            if (qty < 1) return deleteItem(id);
            await fetch(`${API_BASE}/cart/${id}/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                body: JSON.stringify({ quantity: qty })
            });
            fetchCart(); // é‡æ–°è®€å–è³‡æ–™åˆ·æ–°ç•«é¢
        }

        /**
         * åˆªé™¤è³¼ç‰©è»Šå•†å“
         * @param {number} id - è³¼ç‰©è»Šé …ç›®çš„ ID
         */
        async function deleteItem(id) {
            if (confirm("ç¢ºå®šè¦å¾è³¼ç‰©è»Šç§»é™¤é€™é …å•†å“å—ï¼Ÿ")) {
                await fetch(`${API_BASE}/cart/${id}/`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': `Token ${token}` } 
                });
                fetchCart(); // é‡æ–°è®€å–è³‡æ–™åˆ·æ–°ç•«é¢
            }
        }

        /**
         * åŸ·è¡Œçµå¸³æµç¨‹
         */
        async function checkout() {
            const points = document.getElementById('input-points').value || 0;
            const res = await fetch(`${API_BASE}/cart/checkout/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                body: JSON.stringify({ use_points: points })
            });
            const result = await res.json();
            if (res.ok) {
                alert("è¨‚å–®å·²æˆç«‹ï¼Œæº–å‚™å‰å¾€ä»˜æ¬¾ï¼");
                // çµå¸³æˆåŠŸå¾Œè·³è½‰è‡³ä»˜æ¬¾é é¢ï¼Œä¸¦æ”œå¸¶è¨‚å–® ID
                window.location.href = `/payment/?id=${result.order_id}`;
            } else {
                // é¡¯ç¤ºå¾Œç«¯å‚³å›çš„éŒ¯èª¤è¨Šæ¯ï¼ˆä¾‹å¦‚é»æ•¸ä¸è¶³æˆ–åº«å­˜ä¸è¶³ï¼‰
                alert(result.detail || "çµå¸³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•åŸ·è¡Œè®€å–
        window.onload = fetchCart;
    </script>
</body>
</html>